<!DOCTYPE html>
<html>
	<head>
	
	<meta charset="UTF-8">
	
	<title>向导式工单申报</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
	
	<!-- <link rel="stylesheet" href="../js/jquery/jqm1.3.0/jquery.mobile-1.3.0.min.css" />
	<link rel="stylesheet" href="../style/css/mobile.css" /> -->
	<link rel="stylesheet" href="../style/css/common.css" />
	<link rel="stylesheet" href="../style/css/main.css" />
	<link rel="stylesheet" href="../style/css/font-awesome.min.css" />

	<script src="../js/jquery/1.7.1/jquery-1.7.1.min.js"></script>
	
	<script src="../js/spin.min.js" ></script>  
	<script src="../js/mobile.js" ></script>
	<script src="../js/popmenu.js"></script>	
	<script src="../js/jquery.cookie.js"></script>  
	<script src="../js/alertPopShow.js" ></script>
	<script src="http://api.map.baidu.com/api?v=2.0&ak=zRLeQBFG9tHyef5FnjMVF92LWidtKcPh" type="text/javascript"></script>
    <script src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js&quot" type="text/javascript" ></script>
    <script src="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js&quot" type="text/javascript" ></script>
	<script src="../js/giveLngAndLat.js" ></script>    
	
	<script type="text/javascript">
	    var  $content=null;
	    var  $buildingListToArea=null;
	    var  $orderTypeFatherList=null;
	    var  $orderTypeChildList=null;
	    var wcpUrl = null;//定义全局变量用于存储wcpUrl
	    
	   	var errorMsg = "服务器错误!";
	   	var maxFileSizeMsg = "图片太大，请上传10M以内的照片!";
	 
	   	var allInfoToLou = null;
	   	var areaInfoToBack = null;

		var orderTypeChildTwoList=null;
		
		window.onpageshow = function(event){
			   if (event.persisted) {
			       window.location.reload();
			   }
			};

	    //连接
	    function connect() {
			loadSpin("#wrap"); //转圈
	    	$.ajax({
				url :  '../WebRequest',  
		    	type : 'POST',  
		    	dataType : 'json', 
		    	data: {type: 'OrderApplyDetail'},
		    	error : function() {
		    		closeSpin();
		           // alert(errorMsg);
		        },  
		        success : function(jsonObj) {  
		        	 if(jsonObj != null){
		        		wcpUrl = jsonObj.wcpUrl;//把url赋值给全局变量
		        		initMenu(jsonObj.roleflag,jsonObj.adminflag);
		        		if (jsonObj.type == "OrderApplyDetail" && jsonObj.value == "-1"){
							goLogin();
						}else
		            	if(jsonObj.type == "OrderApplyDetail" && jsonObj.value == "1"){
		            		$content=jsonObj.content;
		            		$buildingListToArea=eval(jsonObj.jstoArea.buildingListToArea);
		            		$orderTypeFatherList=eval(jsonObj.jsonOrderTypeFather.orderTypeFatherList);
		            		$orderTypeChildList=eval(jsonObj.jsonOrderTypeChild.orderTypeChildList);
		            		
		            		  if(isEmptyStr($content.filler)||isEmptyStr($content.stuEmpno)||isEmptyStr($content.tel)||isEmptyStr($content.wechat)){
		            		      showWorkOrder($content,$buildingListToArea,$orderTypeFatherList,$orderTypeChildList);
		            		   }else{
		            			 showWorkOrder2($content,$buildingListToArea,$orderTypeFatherList,$orderTypeChildList);
		            			  //window.location.href = "guideStyleApply2.html";
		            		      }
		            		  
		            	}else{
							closeSpin();  //关闭转圈
						}	
		            }else{
		            	closeSpin();
		            }
		        }  
			});
			closeSpin();
	    }
	    function goLogin(){
	    	top.location.href='/cugItsm/html/index.jsp';
	    }
		
	    
		//明细
		function showWorkOrder(content,jstoArea,orderTypeFatherList,orderTypeChildList){
			allInfoToLou = content.locations;//赋值给全局变量
			orderTypeChildTwoList = orderTypeChildList;//赋值给全局变量
			$("#contentDiv").get(0).innerHTML = "";
			var htmlTmp = "";
       	
			htmlTmp += '<form   method="post" id="workOrderAddForm1" action="${ctx}/workorderInput/add" enctype="multipart/form-data">';
			htmlTmp += '<span class="list_group">故障申报服务工单申请</span>';
			htmlTmp += '<span class="ser_code"><i class="icon-paste"></i>服务单号 <i id="ticketNo">'+ content.ticketNo + '</i></span>'; 
    		htmlTmp += '<span class="content_size">';
			htmlTmp += '<table class="content_table">';
        	htmlTmp += '<tr><td class="">填单人</td><td class="need"><input type="text" name="filler" id="filler" value="'+content.filler+'"/></td></tr>';
			htmlTmp += '<tr><td class="">学工号</td><td class=""><input type="text" name="stuEmpno" id="stuEmpno" readonly="readonly" value="'+content.stuEmpno+'"/></td></tr>';
			htmlTmp += '<tr><td class="">联络方式</td><td class="need"><input type="text" name="tel" id="tel" value="'+content.tel+'"/></td></tr>';
			htmlTmp += '<tr><td class="">微信号</td><td class="need"><input type="text" name="webchat" id="webchat" value="'+content.webchat+'"/><input type="text" id="tempTicketNo" value="" hidden="true"/></td></tr>';
			
		
   		 /* 	htmlTmp +='<tr ><td class="trackTD">关键字</td><td class="trackTDVal"><input type="text" name="word" id="word" maxlength="100" style="border:1px solid gray;border-radius:3px;height:30px;padding-left:3px;box-sizing:border-box;background:white"/>';
   			htmlTmp += '<button class="button blue" type="button" onclick="searchByWord()">搜索</button></td></tr>'; */
   			
   			htmlTmp += '</table>';
   			htmlTmp += '</span>';
   			htmlTmp += '<span class="action_btn">';
   			htmlTmp += '<button type="button" class="marginR08r width50" id="btn" onclick="next()">下一步</button>';
   		 	//var shtmlTmp ="";
   			//shtmlTmp += '<button type="button" class="button blue" onclick="send('+content.ticketNo +')">提交</button>';
   			//alert("shtmlTmp---" +shtmlTmp); 
   			//htmlTmp += '<button type="button" class="button blue" onclick="clearVal()">返回</button>';
   			htmlTmp += '<button type="button" class="width50" onclick="back()">返回</button>';
   			htmlTmp+='</span>';   			
   			htmlTmp += '</form>';
			
    		//$("#contentDiv").get(0).innerHTML = htmlTmp;
    		$("#contentDiv").append(htmlTmp);
	    	
	    	
	    	closeSpin();
			
		}
		
		function showWorkOrder2(content,jstoArea,orderTypeFatherList,orderTypeChildList){
			allInfoToLou = content.locations;//赋值给全局变量
			orderTypeChildTwoList = orderTypeChildList;//赋值给全局变量
			//$("#contentDiv").get(0).innerHTML = "";
			var htmlTmp = "";
			htmlTmp += '<form   method="post" id="workOrderAddForm2" action="${ctx}/workorderInput/add" enctype="multipart/form-data">';
			htmlTmp += '<span class="list_group">故障申报服务工单申请</span>';
			htmlTmp += '<span class="ser_code"><i class="icon-paste"></i>服务单号 <i id="ticketNo">'+ content.ticketNo + '</i></span>';        	
			htmlTmp += '<span class="content_size">';
			htmlTmp += '<table class="content_table spe_table alignCenter">';
        	htmlTmp += '<tr><td>请选择故障的线路类型</td><td>';
        	htmlTmp += '<select id="queTypeFather"  name="queTypeFather" onchange="setChange(this.value)">';
        	htmlTmp +='<option value= "">请选择故障的线路类型'+'</option>';
        	for(i = 0;i < orderTypeFatherList.length;i++){
				htmlTmp += '<option value= "'+orderTypeFatherList[i].uniqueID+'">'+orderTypeFatherList[i].typeName+'</option>';
			}
			htmlTmp += '</select>&nbsp;&nbsp;</td></tr>';
			
        	htmlTmp += '<tr><td>请选择故障的类型</td><td>';
        	htmlTmp += '<select id="queTypeName"  name="queTypeName" onchange="showBroadcast()">';
        	htmlTmp +='<option value= "">请选择故障的类型'+'</option>';
        	for(i = 0;i < orderTypeChildList.length;i++){
 				if(orderTypeChildList[i].pid=="1"){
 					htmlTmp += '<option value= "'+orderTypeChildList[i].uniqueID+'">'+orderTypeChildList[i].typeName+'</option>';	
 				}
			} 
			htmlTmp += '</select>&nbsp;&nbsp;</td></tr>';
			htmlTmp += '<tr><td>服务地点</td><td>';
			htmlTmp += '<select id="areaServer"  onchange="changeToArea(this.value)">';
			htmlTmp +='<option value= "">请选择区域'+'</option>';
			for(i = 0;i < jstoArea.length;i++){
				htmlTmp += '<option   value= "'+jstoArea[i].dictID+'">'+jstoArea[i].dictName+'</option>';
			}
			htmlTmp += '</select>&nbsp;&nbsp;';
			htmlTmp += '<select id="location"  onchange="showBroadcast()">';
			htmlTmp +='<option value= "">请选择楼栋'+'</option>';
 			for(i = 0;i < content.locations.length;i++){
 				if(content.locations[i].pid=="1"){
 					htmlTmp += '<option  value= "'+content.locations[i].dictID+'">'+content.locations[i].dictName+'</option>';	
 				}
			} 
			htmlTmp += '</select><select id ="floors"  onchange="showBroadcast()">';
			htmlTmp +='<option value= "">请选择楼层'+'</option>';
			var floors = content.topFloor*1;
			for(i = 1;i <= floors;i++){
				htmlTmp += '<option value= "'+i+'">'+i+'楼</option>';
			} 
			htmlTmp += '</select>';
			htmlTmp += '</td></tr>';
			htmlTmp += '<tr><td>详细地址</td><td class="need"><input type="text" name="room" id="room" placeholder="请填写详细地址"/></td></tr>';
			htmlTmp += '</table>';
   			htmlTmp += '</span>';
   			
			//htmlTmp+='<div> <div> <div> <div class="media"><div class="media-body"><div id="content" style="margin-left: 4px;" class="pull-left"></div></div></div></div> </div></div>'
			
			
			htmlTmp += '<span class="action_btn">';
   			htmlTmp += '<button type="button" class="marginR08r width50" id="btNext" onclick="next2()">下一步</button>';
   		 	//var shtmlTmp ="";
   			//shtmlTmp += '<button type="button" class="button blue" onclick="send('+content.ticketNo +')">提交</button>';
   			//alert("shtmlTmp---" +shtmlTmp); 
   			//htmlTmp += '<button type="button" class="button blue" onclick="clearVal()">返回</button>';
   			htmlTmp += '<button type="button" class="width50" onclick="back()">返回</button>';
   			htmlTmp += '<div class="clearfix"></div>';
   			htmlTmp+='</span>';   		
   			
   		
   			
   		 /* 	htmlTmp +='<tr ><td class="trackTD">关键字</td><td class="trackTDVal"><input type="text" name="word" id="word" maxlength="100" style="border:1px solid gray;border-radius:3px;height:30px;padding-left:3px;box-sizing:border-box;background:white"/>';
   			htmlTmp += '<button class="button blue" type="button" onclick="searchByWord()">搜索</button></td></tr>'; */
   			
   			htmlTmp +='<div id="broadcast" class="error_information_area"> </div>';
   			htmlTmp += '</form>';
   			
   			
   		
    		//$("#contentDiv").get(0).innerHTML = htmlTmp;
	    	$("#contentDiv").append(htmlTmp);
    		$("#btNext").hide();
    		$("#broadcast").hide();
	    	closeSpin();
		}
		
		function showWorkOrder3(content,jstoArea,orderTypeFatherList,orderTypeChildList){
			allInfoToLou = content.locations;//赋值给全局变量
			orderTypeChildTwoList = orderTypeChildList;//赋值给全局变量
			//$("#contentDiv").get(0).innerHTML = "";
			var htmlTmp = "";
			htmlTmp += '<form   method="post" id="workOrderAddForm3" action="${ctx}/workorderInput/add" enctype="multipart/form-data">';
			htmlTmp += '<span class="list_group">故障申报服务工单申请</span>';
			htmlTmp += '<span class="ser_code"><i class="icon-paste"></i>服务单号 <i id="ticketNo">'+ content.ticketNo + '</i></span>';        	
			htmlTmp += '<span class="content_size">';
    		htmlTmp += ' <table class="content_table alignCenter">';
        	htmlTmp += '<tr><td>服务地点</td><td>';
        	htmlTmp += $("#areaServer").find("option:selected").text()+"-"+$("#location").find("option:selected").text()+"-"+$("#floors").find("option:selected").text();
        	htmlTmp += '</td></tr>';
        	htmlTmp += '<tr><td>故障类型</td><td>';  
        	htmlTmp += $("#queTypeFather").find("option:selected").text()+"-"+$("#queTypeName").find("option:selected").text();
			htmlTmp += '</td></tr>';			
			
			
			htmlTmp += '<tr><td>问题描述</td><td class="need"><textarea name="queDesc" id="queDesc" class="pro_textarea" placeholder="请填写问题描述"></textarea></td></tr>';
			//htmlTmp += '<tr><td><div id="wcp" style=""></div></td></tr>';
			htmlTmp += '<tr><td>附件上传</td><td><div class="file"><input type="file" accept="image/*" name="file" capture="camera" id="pic"/></div><div id="imgs"></div></tr>';
			htmlTmp += '</table>';
   			htmlTmp += '</span>';
   			
			htmlTmp += '<span class="action_btn">';
   			htmlTmp += '<button type="button" class="width30" id="btn" onclick="pre()">上一步</button>';
   			htmlTmp += '<button type="button" class="width30" class="width50" onclick="send()">提交</button>';
   		 	//var shtmlTmp ="";
   			//shtmlTmp += '<button type="button" class="button blue" onclick="send('+content.ticketNo +')">提交</button>';
   			//alert("shtmlTmp---" +shtmlTmp); 
   			//htmlTmp += '<button type="button" class="width30" onclick="clearVal()">清除</button>';
   			htmlTmp += '<button type="button" class="width30" onclick="back()">返回</button>';
   			htmlTmp += '<div class="clearfix"></div>';
   			htmlTmp += '</span>';
   			
   		 /* 	htmlTmp +='<tr ><td class="trackTD">关键字</td><td class="trackTDVal"><input type="text" name="word" id="word" maxlength="100" style="border:1px solid gray;border-radius:3px;height:30px;padding-left:3px;box-sizing:border-box;background:white"/>';
   			htmlTmp += '<button class="button blue" type="button" onclick="searchByWord()">搜索</button></td></tr>'; */
   			
   		
   			htmlTmp += '<div class="search_result" ><div id="wcp" class="guid"></div></div>';
   			
   			htmlTmp += '</form>';
   		
	    	$("#contentDiv").append(htmlTmp);
	    	
    		$('#queDesc').bind('input propertychange', function() {
    			// $('#wcp').empty();//每次调用清空div的值，否则div的值会累加
    			// console.log($(this).val());
    			$.ajax({ 
    		        type:'get',
    		        async: false,
    		        url:wcpUrl+"/websearch/PubDoWechat.do", 
    		        dataType:'jsonp',  // 处理Ajax跨域问题
    		        jsonp:'callbackparam',  
    		         data:{'word':encodeURI($(this).val())},
    		         jsonpCallback:"success_jsonpCallback",  
    		         success: function(data){ 
    		        var resultList= data.resultList;
    		        $('#wcp').empty();//每次调用清空div的值，否则div的值会累加，放在for循环的外面
    		       for(var o in resultList){ 
    		         	 
    				 //var div1='<div><a href="http://127.0.0.1:8080/wcp/actionImg/PubloadfileDoc'+resultList[o].ID+'.html" >'+resultList[o].TITLE+'</a></div>';
    		         var div1='<div class="">'+
    		         '<a class="" href="'+wcpUrl+'/actionImg/PubloadfileDoc'+resultList[o].ID+'.html" >'+resultList[o].TITLE
    		          +'<i class="icon-download-alt"></i></a></div>';//<span style="color: #d9534f;" class="glyphicon glyphicon-download-alt"></span>
    			
    		           var div2='<div>'+
    		           '<p class="">'+resultList[o].DOCDESCRIBE+'</p>';
    		           
    		           
    		           var div3='<p class="">'+resultList[o].FILECONTENT+'</p>';
    		           if(resultList[o].FILECONTENT!=null){
    		        	  // div2+='<p class="">-------(以下为附件中检索到的内容片段)---------</p>'+div3+'</div>';
    		        	   //div2+=div3+'</div>';
    		           }else{
    		        	   div2+='</div>';
    		           }
    		         
    		           
    		           
    		           
    			      // $('#wcp').append(div1).append(div2); 
    			       $('#wcp').append(div2); 
    			       if(resultList.length>0){
    			       $("#wcp").show();
    			       }
    		       }  
    		        	
    		        	
    		       } ,
    	 	         error: function(err){
    	 	        	// webToast("系统出现问题，请联系请管理员！",1000);
    	 	        }
    		    });  
    		    
    		});
    		showPic();//最后一步页面加载完后，把图片上传的代码放到showPic里面调用一次，否则不会执行里面的代码。
	    	closeSpin();
    		
	    	$("#wcp").hide();
		}		
		
		// Check string not empty
		function isEmptyStr(s)
		{
		    return ((s==null) || ($.trim(s).length == 0));
		}
		

		//根据选择的值去广播信息索引
	 	function showBroadcast(){
	             var queTypeFather=$("#queTypeFather").val();//故障线路类型
	             var queTypeName=$("#queTypeName").val();//故障类型
	             var areaServer=$("#areaServer").val();//服务区域
	             var location=$("#location").val();//服务楼栋
	             var floors=$("#floors").val();//服务楼层

	          
	             if(isEmptyStr(queTypeFather) || isEmptyStr(queTypeName) ||isEmptyStr(areaServer) ||isEmptyStr(location)|| isEmptyStr(floors)){
	            	 $("#btNext").hide();
	            	 $("#broadcast").hide();
	                return false;
	             }else{
	            		 $("#btNext").show();
	            		
	            		searchOnBroadcast(queTypeFather,queTypeName,areaServer,location,floors);
	             }
	             
			
			
		} 
		
	     function searchOnBroadcast(queTypeFather,queTypeName,areaServer,location,floors) {
	    	 loadSpin("#wrap"); //转圈
	    	 var jsonParam = jQuery.param({ "queTypeFather":queTypeFather,"queTypeName":queTypeName,"areaServer":areaServer,"location":location,"floors":floors});
	    	   	$.ajax({  
	        		url :'../broadcast/search',
	                type:"POST",  
	                async: false,  
	                data: jsonParam,
	                dataType: "json",  
	                cache: false,  
	              success: function (jsonObj) {
			        	 	 var html='<ul class="error_ul">';
			        	 	// var result=JSON.parse(jsonObj);
			        		 for(var i=0;i<jsonObj.length;i++){
			        			 html+="<li>"+jsonObj[i].content+"</li>";
			        		 }
			        		 html+='</ul>'
			        	 	$("#broadcast").empty();
			            	$("#broadcast").append(html);  
			            	if(jsonObj.length>0){
			            	 $("#broadcast").show();
			            	}
	                } 
	            });
	    	closeSpin();
	    }  
		
		//改变问题类型的值
		function setChange(parentValue){
			var info = '<option value= "">请选择故障的类型'+'</option>';
			for(var i=0;i<orderTypeChildTwoList.length;i++){ 
				if(parentValue==orderTypeChildTwoList[i].pid){
					info +="<option value="+orderTypeChildTwoList[i].uniqueID+">"+orderTypeChildTwoList[i].typeName+"</option>";
				}
				
			}
			
			$("#queTypeName").html(info);
			showBroadcast();
		}
		
		//改变区域的值
		function changeToArea(areaValue){

			var areaValue = $("#areaServer").val();
			var infoToLouOne = null;
			var info = '<option value= "">请选择楼栋'+'</option>';
			for(var i=0;i<allInfoToLou.length;i++){ 
				if(areaValue==allInfoToLou[i].pid){
					info +="<option value="+allInfoToLou[i].dictID+">"+allInfoToLou[i].dictName+"</option>";
				}
				
			}
			
			$("#location").html(info);

			showBroadcast();
		}

		//上一步
		function pre(){
			$("#workOrderAddForm3").hide();
			$("#workOrderAddForm2").show();
			
			//showWorkOrder2($content,$buildingListToArea,$orderTypeFatherList,$orderTypeChildList);
		}
		
		//下一步
		function next(){
			loadSpin("#wrap"); //转圈
			var filler=$("#filler").attr("value");	
			var stuEmpno=$("#stuEmpno").attr("value");
			var tel=$("#tel").attr("value");	
		 	var webchat=$("#webchat").attr("value");
		 	var myreg=/^[1][3,4,5,7,8][0-9]{9}$/;
		 	var reg = /^[A-Za-z0-9\u4e00-\u9fa5]{1,32}$/;
		 	var namereg =/[A-Za-z0-9_\-\u4e00-\u9fa5]+/;
		 	if(isEmptyStr(filler)){
		 		popTipShow.alert('提示','请输入填单人！', ['知道了'],
        				function(e){
        				  //callback 处理按钮事件		  
        				  var button = $(e.target).attr('class');
        				  if(button == 'ok'){
        					//按下确定按钮执行的操作
        					//todo ....
        					this.hide();
        				  }	
        					$("#filler").focus();
        				  closeSpin();  //关闭转圈
        				}
        			);
				return false;
		 	}else if(!namereg.test($.trim(filler))){
		 		popTipShow.alert('提示','填单人输入内容只能是汉字、数字、字母、符号且不能以符号开头！', ['知道了'],
        				function(e){
        				  //callback 处理按钮事件		  
        				  var button = $(e.target).attr('class');
        				  if(button == 'ok'){
        					//按下确定按钮执行的操作
        					//todo ....
        					this.hide();
        				  }	
        					$("#filler").focus();
        				  closeSpin();  //关闭转圈
        				}
        			);
				return false;
		 	}
	
		 	if(isEmptyStr(tel)){
		 		popTipShow.alert('提示','请输入联络方式！', ['知道了'],
        				function(e){
        				  //callback 处理按钮事件		  
        				  var button = $(e.target).attr('class');
        				  if(button == 'ok'){
        					//按下确定按钮执行的操作
        					//todo ....
        					this.hide();
        				  }	
        					$("#tel").focus();
        				  closeSpin();  //关闭转圈
        				}
        			);
				return false;
		 	}else if(!myreg.test(tel)){
		 		popTipShow.alert('提示','请输入正确的联络方式！', ['知道了'],
        				function(e){
        				  //callback 处理按钮事件		  
        				  var button = $(e.target).attr('class');
        				  if(button == 'ok'){
        					//按下确定按钮执行的操作
        					//todo ....
        					this.hide();
        				  }	
        					$("#tel").focus();
        				  closeSpin();  //关闭转圈
        				}
        			);
				return false;
		 	}
		 	
		 	if(isEmptyStr(webchat)){
		 		popTipShow.alert('提示','请输入微信号！', ['知道了'],
        				function(e){
        				  //callback 处理按钮事件		  
        				  var button = $(e.target).attr('class');
        				  if(button == 'ok'){
        					//按下确定按钮执行的操作
        					//todo ....
        					this.hide();
        				  }	
        					$("#wechat").focus();
        				  closeSpin();  //关闭转圈
        				}
        			);
				return false;
		 	}else if(!reg.test($.trim(webchat))){
		 		popTipShow.alert('提示','微信号输入内容只允许数字、字母、汉字且不超过32位！！', ['知道了'],
        				function(e){
        				  //callback 处理按钮事件		  
        				  var button = $(e.target).attr('class');
        				  if(button == 'ok'){
        					//按下确定按钮执行的操作
        					//todo ....
        					this.hide();
        				  }	
        					$("#webchat").focus();
        				  closeSpin();  //关闭转圈
        				}
        			);
				return false;
		  		
		 	} 
			$("#workOrderAddForm1").hide();
			showWorkOrder2($content,$buildingListToArea,$orderTypeFatherList,$orderTypeChildList);
			//window.location.href = "guideStyleApply.html";
			//window.location.href = "guideStyleApply2.html";
			closeSpin();
		}
		
		function next2(){
		    loadSpin("#wrap"); //转圈
		    var room=$("#room").val();
		 	var reg = /^[A-Za-z0-9\u4e00-\u9fa5]{1,32}$/;
		 	
		    if(isEmptyStr(room)){
		      	 popTipShow.alert('提示','请输入详细地址！', ['知道了'],
	         				function(e){
	         				  //callback 处理按钮事件		  
	         				  var button = $(e.target).attr('class');
	         				  if(button == 'ok'){
	         					//按下确定按钮执行的操作
	         					//todo ....
	         					this.hide();
	         				  }	
	         					$("#room").focus();
	         				  closeSpin();  //关闭转圈
	         				}
	         			);
         	 return false;
		    }else if(!reg.test($.trim(room))){
		    	popTipShow.alert('提示','详细地址输入内容只允许数字、字母、汉字且不超过32位！', ['知道了'],
        				function(e){
        				  //callback 处理按钮事件		  
        				  var button = $(e.target).attr('class');
        				  if(button == 'ok'){
        					//按下确定按钮执行的操作
        					//todo ....
        					this.hide();
        				  }	
        					$("#room").focus();
        				  closeSpin();  //关闭转圈
        				}
        			);
				return false;
		    }
		 	//window.location.href = "guideStyleApply3.html";
		 	$("#workOrderAddForm2").hide();
		 	if($("#workOrderAddForm3").length>0){
		 	$("#workOrderAddForm3").show();
		 	}else{
			showWorkOrder3($content,$buildingListToArea,$orderTypeFatherList,$orderTypeChildList);
		 	}
			closeSpin(); 
		}
		
		//返回
		function back(){
			loadSpin("#wrap"); //转圈
			window.location.href = "workorderTrack.html";
			htmlTmp = "";
			closeSpin();
		}
		
		function showPic(){
			//var imgsrc=[];	//定义一个空数组，用来存放img的src
			setTimeout(function(){
				//拍照上传功能
				var inputs = document.getElementById("pic");			
				var imageType = /image.*/;
				var imgs=document.getElementById("imgs");
				
				var getOnloadFunc = function(aImg) {
						return function(evt) {
							aImg.src = evt.target.result;
							//alert(aImg.src);
	                    }
					};
						
				    
				if(inputs){	
					inputs.addEventListener("change", function(evt) {					
					    for (var i = 0, numFiles = this.files.length; i < numFiles; i++) {
					        var file = this.files[i];
					        if (!file.type.match(imageType)) {
					            continue;
					        }
						    var img = document.createElement("img");
						    

						    var reader = new FileReader();					   					    
						    reader.onload = getOnloadFunc(img);					
						    img.className="IMG";
						   // imgs.appendChild(img);
						    	                    
						    var canvas = document.createElement("canvas");
						   canvas.style.width="100px";
						   canvas.style.height="130px";
						    imgs.appendChild(canvas);
						    var ctx = canvas.getContext('2d');
						    img.onload = function() {
	                        var w = img.naturalWidth,
	                        h = img.naturalHeight;
	                        canvas.width = w;
	                        canvas.height = h;
	                        ctx.drawImage(img, 0, 0, w, h, 0, 0, w/1, h/1);	 
	                		$("canvas").on("click",function(){
                        	if($(this).attr("class")=="big") {
                        	 $(this).removeClass("big");
                			  canvas.style.width="100px";
   					          canvas.style.height="130px";
   					          drawImage();
                        	}else{
                			    $(this).addClass("big");
                   			    canvas.style.width="65%";
					            canvas.style.height="50%";
					            drawImage();
                        	    }
                		      })
	                        fileUpload();
	                        function fileUpload() {
	       				     var data = canvas.toDataURL("image/jpeg", 0.5);
	       				     var imgdata = data;
	       				     //dataURL 的格式为 “data:image/png;base64,****”,逗号之前都是一些说明性的文字，我们只需要逗号之后的就行了
	       				    data = data.split(',')[1];
	       				    data = window.atob(data);
	       				    var ia = new Uint8Array(data.length);
	       				    for (var i = 0; i < data.length; i++) {
	       				          ia[i] = data.charCodeAt(i);
	       				    };
	       				     //canvas.toDataURL 返回的默认格式就是 image/png
	       				    var blob = new Blob([ia], {
	       				     type: "image/jpeg"
	       				    });
	       					var fup = document.getElementById("pic");
	       					var fileSize =  fup.files[0].size;//得到图片大小
	       					var fileName =  fup.files[0].name;//得到图片名称
	       				    var formData = new FormData($("#workOrderAddForm3")[0]);  
	    					formData.append("myFile",blob);
	    					formData.append("imgdata",imgdata);
	    					formData.append("fileSize",fileSize);
	    					formData.append("fileName",fileName);
	    					var ticketNo = $("#ticketNo").get(0).innerHTML;
	    					formData.append("ticketNo",ticketNo);
	    					loadSpin("#wrap"); //转圈   			    	
	    			    	$.ajax({
	    						url :  '../WebUpload',  
	    						type: 'POST',  
	    			          	data:formData,
	    			          	async: false,  
	    			            cache: false,  
	    			          	contentType: false,  
	    			          	processData: false, 
	    			          	dataType: "json",
	    				    	error : function() {
	    				    		closeSpin();
	    				            //alert(maxFileSizeMsg);
	    				            popTipShow.alert('提示 ',maxFileSizeMsg, ['知道了'],
				            				function(e){
				            				  //callback 处理按钮事件		  
				            				  var button = $(e.target).attr('class');
				            				  if(button == 'ok'){
				            					//按下确定按钮执行的操作
				            					//todo ....
				            					this.hide();
				            				  }	
				            				}
				            			);
	    				            
	    				        },  
	    				        success : function(jsonObj) {  
	    				        	 if(jsonObj != null){
	    				        		 if(jsonObj.message == "fileTooMax"){
	    				        			 //alert("图片太大，请上传"+jsonObj.maxPicSize+"M以内的照片");
	    				        			 
	    				        			 popTipShow.alert('提示 ','图片太大，请上传'+jsonObj.maxPicSize+'M以内的照片', ['知道了'],
	    					            				function(e){
	    					            				  //callback 处理按钮事件		  
	    					            				  var button = $(e.target).attr('class');
	    					            				  if(button == 'ok'){
	    					            					//按下确定按钮执行的操作
	    					            					//todo ....
	    					            					this.hide();
	    					            				  }	
	    					            				}
	    					            			);
	    				        			 
	    				        			 
	    				        		 }else{    				        			 
	    				            		//alert(jsonObj.message);
	    				        		 }
	    				            	$("#tempTicketNo").val(jsonObj.ticketNo);
	    				            }else{
	    				            	closeSpin();
	    				            }
	    				        }  
	    					});
	    					
	    						
	                        };
						    }
						    closeSpin();
						    reader.readAsDataURL(file);
					    }
					},false);
				}	
			},2000)
				
		}
		
		


		
 		//送出
 		function send(){
			loadSpin("#wrap"); //转圈
			//alert("send");			
			var ticketNo = $("#ticketNo").get(0).innerHTML;
			//alert("send----"+ticketNo);
			var location = $("#location").val();
			var floor = $("#floors").val();
			var filler = $("#filler").val();		
			var tel = $("#tel").val();	
			var webchat = $("#webchat").val();		
			var room = $("#room").val();
			var queTypeName = $("#queTypeName").val();
			var queDesc = $("#queDesc").val();
			var myreg=/^[1][3,4,5,7,8][0-9]{9}$/;
    		var reg = /^[A-Za-z0-9\u4e00-\u9fa5]{1,32}$/;
      		 if($.trim(filler) == ""){
				alert("填单人不能为空");
				return false;
			}else if(!reg.test($.trim(filler))){
				alert("输入内容只允许数字、字母、汉字且不超过32位");
				return false;
			}	else if($.trim(tel) == ""){
				alert("联络方式不能为空");
				return false;
			}else if(!myreg.test($.trim(tel))){
				alert("请输入正确的联络方式");
				return false;
			}	else if(!reg.test($.trim(webchat))){
				alert("输入内容只允许数字、字母、汉字且不超过32位");
				return false;
			}
			else if($.trim(room) == ""){
				alert("详细地址不能为空");
				return false;
			}else if(!reg.test($.trim(room))){
				alert("输入内容只允许数字、字母、汉字且不超过32位");
				return false;
			}else  if($.trim(queDesc) == ""){
				alert("问题描述不能为空");
				return false;
			}else if(!reg.test($.trim(queDesc))){
				alert("输入内容只允许数字、字母、汉字且不超过32位");
				return false;
			}
			//alert(imgsrc);
	     	$.ajax({
				url :  '../WebRequest',  
		    	type : 'POST',  
		    	dataType : 'json',
		    	async: false,  
	            cache: false, 
		    	data: {type: 'SendApply',ticketNo:ticketNo,location:location,floor:floor,filler:filler,tel:tel,webchat:webchat,room:room,queTypeName:queTypeName,queDesc:queDesc},
		    	error : function() {
		    		closeSpin();
		           // alert(errorMsg);
		        },  
		        success : function(jsonObj) {  
		        	 if(jsonObj != null){
		        		 if (jsonObj.type == "SendApply" && jsonObj.value == "-1"){
								goLogin();
							}else
		            	if(jsonObj.type == "SendApply" && jsonObj.value == "1"){
		            		//alert("送出成功！33gg");
		            		 sendMessage();
		            		popTipShow.alert('提示 ','送出成功', ['知道了'],
		            				function(e){
		            				  //callback 处理按钮事件		  
		            				  var button = $(e.target).attr('class');
		            				  if(button == 'ok'){
		            					//按下确定按钮执行的操作
		            					//todo ....
		            					this.hide();
		            				  }	
		            				  if(jsonObj.orderSyncSwitch == "on" && jsonObj.systemValidateType == "tiup"){		            					  
		            				  	synInfo(jsonObj.ticketNo);
		            				  }else{
		            					  back();
		            				  }		            				  
		            				  $("#btn").attr("disable","disabled");
		            				  $("#btn").css({
		            					  background:"#ccc",
		            					  border:"1px solid #ccc",
		            					  boxShadow: "none"
		            				  })
		            				  
		            				  
		            				 
		            				}
		            			);
		            		
		            		//alert("ticketNo" +jsonObj.ticketNo);
		            		
		            		//back();
		            	}else if((jsonObj.type == "SendApply" && jsonObj.value == "0")){
		            		//alert("送出失败！");
		            		popTipShow.alert('提示','此单号已存在不能重复申报   送出失败！', ['知道了'],
		            				function(e){
		            				  //callback 处理按钮事件		  
		            				  var button = $(e.target).attr('class');
		            				  if(button == 'ok'){
		            					//按下确定按钮执行的操作
		            					//todo ....
		            					this.hide();
		            				  }	
		            				  closeSpin();  //关闭转圈
		            				  back();
		            				}
		            			);
		            		
							
						}	
		            }else{
		            	closeSpin();
		            }
		        }  
			}); 
			closeSpin();
		}  
 		//发送通知
		function sendMessage(){
			loadSpin("#wrap"); //转圈
			var ticketNo = $("#ticketNo").get(0).innerHTML;
			var tel = isPoneAvailable($.trim($("#tel").val()));
			var webchat = $("#webchat").val();		
			var room = $("#room").val();
			var queTypeName = $("#queTypeName").val();
			var queTypeNameTxt=$("#queTypeName option:selected").text();
			//alert(imgsrc);
	     	$.ajax({
				url :  '../SendMessage',  
		    	type : 'POST',  
		    	dataType : 'json', 
		    	data: {type:'17',ticketNo:ticketNo,tel:tel,webchat:webchat,room:room,queTypeName:queTypeName,queTypeNameTxt:queTypeNameTxt},
		    	error : function() {
		    		closeSpin();
		           // alert(errorMsg);
		        },  
		        success : function(jsonObj) {  
		        	 if (jsonObj.value == "-1"){
							goLogin();
						}else{
							closeSpin();
						}
		        	closeSpin();
		        }
		 })
		}
 		
		 function isPoneAvailable(str) {  
	            var myreg=/^[1][3,4,5,7,8][0-9]{9}$/;  
	            if (!myreg.test(str)) {  
	                return str.substring(3);
	            } else {  
	                return str;  
	            }  
	        }  
		 
		//送出
 		function synInfo(ticketNo){
			//alert("synInfo");
			loadSpin("#wrap"); //转圈
	     	$.ajax({
				url :  '../WebRequest',  
		    	type : 'POST',  
		    	dataType : 'json', 
		    	data: {type: 'SynInfo',ticketNo:ticketNo},
		    	error : function() {
		    		closeSpin();
		            //alert(errorMsg);
		        },  
		        success : function(jsonObj) {  
		        	 if(jsonObj != null){
		        		 if (jsonObj.type == "SynInfo" && jsonObj.value == "-1"){
								goLogin();
							}else
		            	if(jsonObj.type == "SynInfo" && jsonObj.value == "1"){
		            		//alert("同步结果:"+jsonObj.msg);
		            		back();
		            	}else if((jsonObj.type == "SynInfo" && jsonObj.value == "0")){
		            		//alert("同步结果:"+jsonObj.msg);
							closeSpin();  //关闭转圈
							back();
						}	
		            }else{
		            	closeSpin();
		            }
		        }  
			}); 
			closeSpin();
		}  
		
		
		
 		
		

		
		
		window.onload = function (){
			 
			connect();  //页面初始化方法
			
		};
		
		function changeMenuClass(index){
			
			$(".subMenuDiv").removeClass("subMenuDivOn");
			$("#subMenuDiv"+index).addClass("subMenuDivOn");

			$("#subMenuImg1").attr('src','../style/images/menu1.png');
			$("#subMenuImg2").attr('src','../style/images/menu2.png'); 
			$("#subMenuImg3").attr('src','../style/images/menu3.png'); 
			$("#subMenuImg4").attr('src','../style/images/menu4.png'); 
			$("#subMenuImg"+index).attr('src','../style/images/menu' + index + '_on.png'); 
			
			
			var htmlTmp = "";
			if(index == 1){
				loadSpin("#wrap"); //转圈
				//window.location.href = "workOrderApply.html";
				window.location.href = "newWorkOrderApply.html";
				closeSpin();
			}else if(index == 2){
				loadSpin("#wrap"); //转圈
				window.location.href = "workorderTrack.html";
				closeSpin();
			}else if(index == 3){
				loadSpin("#wrap"); //转圈
				window.location.href = "serviceValuation.html";
				closeSpin();
			}else if(index == 4){
				loadSpin("#wrap"); //转圈
				window.location.href='history.html?history=U';
				closeSpin();
			}else if(index == 5){
				loadSpin("#wrap"); //转圈
				window.location.href = "history.html?history=U";
				htmlTmp = "";
				closeSpin();
			}else if(index == 6){
				loadSpin("#wrap"); //转圈
				window.location.href = "grabTkt.html";
				htmlTmp = "";
				closeSpin();
			}
			
			$("#contentDiv").get(0).innerHTML = htmlTmp;

		}
		
		function changeMenuMore(index){
			/* $(".subMenuDiv").removeClass("subMenuDivOn");
			$("#subMenuDiv"+index).addClass("subMenuDivOn");
			if(index == 4){
				$("#subMenuDiv_div").slideToggle(300);
				$("#subMenuDiv"+index).removeClass("subMenuDivOn");
			} */
			ini_menu();  //调用popmenu.js新写的方法
		}
		
		function initMenu(flag,adminflag){ 
			if(flag == "C"){
				$("#menuDiv").hide();
				$("#menuDiv2").hide();
			}
			else if(adminflag == "Y"){
				$("#menuDiv").hide();
				$("#menuDiv2").show();
				//$("#admin_div").show();
			}
			else if(flag == "Y"){
				$("#menuDiv").hide();
				$("#menuDiv2").show();
			}else{
				$("#menuDiv").show();
				$("#menuDiv2").hide();
			}
		}
		
		
	</script>
	
	</head>
	
	<body class="sub_bg">
	
	    	<div id="contentDiv"  class="main_area">
		    	
	    	</div>
	    	
	    	
	    	<!-- <div id="menuDiv" class="menuDiv" hidden="true">
		    	<div id="subMenuDiv1" class="subMenuDiv" onclick="changeMenuClass(1)">
		    		<img id="subMenuImg1"  src="../style/images/menu1.png"><span style="vertical-align:middle;margin-top:10px;">申报</span>
	    		</div>
	    		<div id="subMenuDiv2" class="subMenuDiv" onclick="changeMenuClass(2)">
		    		<img id="subMenuImg2"  src="../style/images/menu2.png"><span style="vertical-align:middle;margin-top:10px;">跟踪</span>
	    		</div>
	    		<div id="subMenuDiv3" class="subMenuDiv" onclick="changeMenuClass(3)">
		    		<img id="subMenuImg3" src="../style/images/menu3.png"><span style="vertical-align:middle;margin-top:10px;">评价</span>
	    		</div>
	    		<div id="subMenuDiv4" class="subMenuDiv" onclick="changeMenuClass(4)">
		    		<img id="subMenuImg4"  src="../style/images/menu4.png"><span style="vertical-align:middle;margin-top:10px;">历史</span>
	    		</div>
	    	</div>
		    
			<div id="menuDiv2" class="menuDiv" hidden="true">
	    		<ul style="width: 100%">
		    	<li id="subMenuDiv1" class="subMenuDiv" onclick="changeMenuClass(1)">
		    		<img id="subMenuImg1"  src="../style/images/menu1.png"><span style="vertical-align:middle;margin-top:10px;">申报</span>
	    		</li>
	    		<li id="subMenuDiv2" class="subMenuDiv" onclick="changeMenuClass(2)">
		    		<img id="subMenuImg2"  src="../style/images/menu2.png"><span style="vertical-align:middle;margin-top:10px;">跟踪</span>
	    		</li>
	    		<li id="subMenuDiv3" class="subMenuDiv" onclick="changeMenuClass(3)">
		    		<img id="subMenuImg3"  src="../style/images/menu3.png"><span style="vertical-align:middle;margin-top:10px;">评价</span>
	    		</li>
	    		
	    		<li id="subMenuDiv4" class="subMenuDiv" onclick="changeMenuMore(4)">
	    			 <div class = "subMenuDiv_div" id = "subMenuDiv_div" hidden="true">
		    			<ul id = "subMenuDiv_ul">
		    			<li class="subMenuLi" onclick="changeMenuClass(5)"><img id="subMenuImg4_1"  src="../style/images/menu4.png"><br><span style="vertical-align:middle;margin-top:10px;">历史</span>
	    				</li>
	    				<li class="subMenuLi" onclick="changeMenuClass(6)"><img id="subMenuImg4_2"  src="../style/images/menu4.png"><br><span style="vertical-align:middle;margin-top:10px;">切换角色</span>
	    				</li>
	    				</ul>
	    			</div>
	    			<img id="subMenuImg4" src="../style/images/menu4.png"><span style="vertical-align:middle;margin-top:10px;">更多</span>
	    		</li>
	    		</ul>
	    	</div> -->
	    	
	 
	     <div id="menuDiv" class="footer_area" hidden="true">
	      <ul class="footer_ul">
           <li class="current"><a href="#" onclick="changeMenuClass(1)"><i class="icon_sb"></i><b>申报</b></a></li>
           <li><a href="#" onclick="changeMenuClass(2)"><i class="icon_gz"></i><b>跟踪</b></a></li>
           <li><a href="#" onclick="changeMenuClass(3)"><i class="icon_pj"></i><b>评价</b></a></li>
           <li><a href="#" onclick="changeMenuClass(4)"><i class="icon_more2"></i><b>历史</b></a></li>
          </ul>
           <span class="bg_span"></span>
          </div> 

	   
	   <div id="menuDiv2" class="footer_area" hidden="true">
		   <ul class="footer_ul">
            <li  class="current"><a href="#" onclick="changeMenuClass(1)"><i class="icon_sb"></i><b>申报</b></a></li>
            <li><a href="#" onclick="changeMenuClass(2)"><i class="icon_gz"></i><b>跟踪</b></a></li>
            <li><a href="#" onclick="changeMenuClass(3)"><i class="icon_pj"></i><b>评价</b></a></li>
            <li id="pop_more"><a href="#" onclick="changeMenuMore(4)"><i class="icon_more2"></i><b>更多</b></li>
          </ul>
	       <span class="bg_span"></span>	
	       
	       	
	   </div>
	   
	   <!--弹出区域start-->
	<div class="pop_area" id="pop_more_content" style="display:none;">
       <ul class="pop_ul">
         <li class="solid"><a href="#" onclick="changeMenuClass(5)"><i class="icon_history"></i><b>历史</b></a></li>
         <li><a href="#" onclick="changeMenuClass(6)"><i class="icon_role"></i><b>切换角色</b></a></li>
       </ul>
	  </div>
	  <!--弹出区域end-->
	    
	</body>
	<script src="../js/app.js" ></script>
</html>